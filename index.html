<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Input Visualizer | Rivolabs | Abhishek Mahato</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Orbitron:wght@400;700&display=swap");

      :root {
        --bg-color: #050505;
        --grid-color: #1a1a1a;
        --primary: #00f3ff;
        --secondary: #bd00ff;
        --accent: #00ff9d;
        --text-color: #e0e0e0;
        --key-base: #0a0a0a;
        --key-top: #1a1a1a;
        --key-shadow: #000;
        --glass: rgba(255, 255, 255, 0.05);
      }

      * {
        box-sizing: border-box;
        user-select: none;
        -webkit-user-select: none;
      }

      body {
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        background-image:
          linear-gradient(var(--grid-color) 1px, transparent 1px),
          linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
        background-size: 40px 40px;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
        font-family: "JetBrains Mono", monospace;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center; /* Centering vertical */
        gap: 20px; /* Space between visualizer and desk */
        color: var(--text-color);
        perspective: 1200px;
      }

      /* Canvas Overlay for Particles */
      #particles {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 100;
      }

      /* Audio Visualizer Canvas */
      #audio-visualizer {
        width: 600px;
        height: 120px;
        z-index: 15;
        /* Neumorphic/Cyber border */
        border-bottom: 2px solid var(--primary);
        mask-image: linear-gradient(
          to bottom,
          transparent 0%,
          black 20%,
          black 100%
        );
        -webkit-mask-image: linear-gradient(
          to bottom,
          transparent 0%,
          black 20%,
          black 100%
        );
        margin-top: 80px; /* Push down from top HUD */
        transform: translateZ(0); /* Hardware accel */
      }

      /* Ambient Lighting */
      .ambient-glow {
        position: absolute;
        width: 60vw;
        height: 60vh;
        background: radial-gradient(
          circle,
          rgba(0, 243, 255, 0.05) 0%,
          transparent 70%
        );
        z-index: 0;
        animation: pulse 10s infinite alternate;
        pointer-events: none;
        transition: all 1s ease-in-out;
      }

      /* Enhanced RGB Vibe Effect */
      body.rgb-mode .ambient-glow {
        width: 120vw;
        height: 120vh;
        background: radial-gradient(
          circle at 50% 50%,
          rgba(255, 0, 0, 0.15),
          transparent 70%
        );
        animation: rgbVibe 10s linear infinite;
        filter: blur(40px);
        opacity: 0.8;
      }

      @keyframes pulse {
        0% {
          opacity: 0.5;
          transform: scale(1);
        }
        100% {
          opacity: 0.8;
          transform: scale(1.1);
        }
      }

      @keyframes rgbVibe {
        0% {
          filter: hue-rotate(0deg) blur(40px);
          opacity: 0.5;
          transform: scale(1);
        }
        50% {
          filter: hue-rotate(180deg) blur(60px);
          opacity: 0.7;
          transform: scale(1.1);
        }
        100% {
          filter: hue-rotate(360deg) blur(40px);
          opacity: 0.5;
          transform: scale(1);
        }
      }

      /* Main Container */
      .desk-setup {
        position: relative;
        z-index: 10;
        display: flex;
        gap: 60px;
        align-items: center;
        transform-style: preserve-3d;
        /* Default Desktop Scale */
        transform: rotateX(30deg) scale(0.9);
        transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        /* Slightly shift down visually */
        margin-bottom: 40px;
      }

      /* iPad Pro / Large Tablet Landscape (1024px - 1366px) */
      @media (max-width: 1400px) {
        .desk-setup {
          transform: rotateX(30deg) scale(0.75);
          gap: 40px;
        }
        #audio-visualizer {
          width: 500px;
          height: 100px;
        }
      }

      /* iPad Air / Standard Tablet Landscape (approx 1000px) */
      @media (max-width: 1100px) {
        .desk-setup {
          transform: rotateX(30deg) scale(0.65);
          gap: 30px;
        }
        #audio-visualizer {
          width: 400px;
        }
      }

      /* iPad Air Portrait / Smaller Tablets (approx 768px - 850px) */
      @media (max-width: 900px) {
        .desk-setup {
          transform: rotateX(30deg) scale(0.55);
          gap: 20px;
        }
        #audio-visualizer {
          width: 300px;
          height: 80px;
        }
      }

      /* --- Keyboard Styles --- */
      .keyboard-frame {
        background: #0f0f0f;
        padding: 18px;
        border-radius: 12px;
        box-shadow:
          0 30px 60px rgba(0, 0, 0, 0.9),
          0 0 0 1px rgba(255, 255, 255, 0.05);
        position: relative;
        border-bottom: 25px solid #050505;
        transform-style: preserve-3d;
        transition: box-shadow 0.3s;
      }

      .keyboard-frame.rgb-active {
        box-shadow:
          0 30px 60px rgba(0, 0, 0, 0.9),
          0 0 0 1px rgba(255, 255, 255, 0.1),
          0 0 60px rgba(0, 243, 255, 0.15);
      }

      /* RGB Underglow */
      .keyboard-frame::before {
        content: "";
        position: absolute;
        inset: -2px;
        background: linear-gradient(
          45deg,
          var(--primary),
          var(--secondary),
          var(--accent)
        );
        z-index: -1;
        filter: blur(25px);
        opacity: 0.3;
        border-radius: 16px;
        animation: rainbow 10s linear infinite;
        transform: translateZ(-5px);
      }

      @keyframes rainbow {
        0% {
          filter: blur(25px) hue-rotate(0deg);
        }
        100% {
          filter: blur(25px) hue-rotate(360deg);
        }
      }

      .keyboard-layout {
        display: grid;
        /* 75% Layout is wider (~16u). 1u = 4 columns. 16 * 4 = 64 columns */
        grid-template-columns: repeat(64, 12px);
        grid-gap: 6px;
        padding: 5px;
        transform-style: preserve-3d;
      }

      .key {
        grid-column: span 4;
        height: 48px;
        position: relative;
        transform-style: preserve-3d;
        transition: transform 0.05s ease-out;
      }

      .key-cap {
        position: absolute;
        inset: 0;
        background: var(--key-top);
        border-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.5);
        transform: translateZ(14px);
        box-shadow:
          inset 0 1px 0 rgba(255, 255, 255, 0.1),
          0 1px 2px rgba(0, 0, 0, 0.3);
        transition: all 0.1s;
      }

      /* RGB Rolling Effect Logic */
      .rgb-mode .key-cap {
        animation: neonWave 4s linear infinite;
        animation-delay: calc(var(--row) * 0.3s);
        border-width: 1px;
      }

      @keyframes neonWave {
        0% {
          border-color: #ff3333;
          color: #ff3333;
          text-shadow: 0 0 5px #ff3333;
          box-shadow:
            0 0 12px rgba(255, 51, 51, 0.4),
            inset 0 0 5px rgba(255, 51, 51, 0.1);
        }
        25% {
          border-color: #33ff33;
          color: #33ff33;
          text-shadow: 0 0 5px #33ff33;
          box-shadow:
            0 0 12px rgba(51, 255, 51, 0.4),
            inset 0 0 5px rgba(51, 255, 51, 0.1);
        }
        50% {
          border-color: #3333ff;
          color: #3333ff;
          text-shadow: 0 0 5px #3333ff;
          box-shadow:
            0 0 12px rgba(51, 51, 255, 0.4),
            inset 0 0 5px rgba(51, 255, 255, 0.1);
        }
        75% {
          border-color: #ff33ff;
          color: #ff33ff;
          text-shadow: 0 0 5px #ff33ff;
          box-shadow:
            0 0 12px rgba(255, 51, 255, 0.4),
            inset 0 0 5px rgba(255, 51, 255, 0.1);
        }
        100% {
          border-color: #ff3333;
          color: #ff3333;
          text-shadow: 0 0 5px #ff3333;
          box-shadow:
            0 0 12px rgba(255, 51, 51, 0.4),
            inset 0 0 5px rgba(255, 51, 51, 0.1);
        }
      }

      .key-cap::before {
        content: "";
        position: absolute;
        bottom: -14px;
        left: 1px;
        right: 1px;
        height: 14px;
        background: var(--key-base);
        border-bottom-left-radius: 4px;
        border-bottom-right-radius: 4px;
        transform: translateZ(-14px) translateY(14px);
        filter: brightness(0.5);
        box-shadow: 0 5px 10px rgba(0, 0, 0, 0.5);
      }

      .key.active {
        transform: translateY(10px);
      }

      .key.active .key-cap {
        background: var(--bg-color) !important;
        color: #fff !important;
        border-color: #fff !important;
        box-shadow: 0 0 30px rgba(255, 255, 255, 0.9) !important;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.9) !important;
      }

      .key.modifier .key-cap {
        font-size: 10px;
        color: rgba(255, 255, 255, 0.3);
        background: #181818;
      }

      /* Specific Key Sizes */
      .u-1-25 {
        grid-column: span 5;
      }
      .u-1-5 {
        grid-column: span 6;
      }
      .u-1-75 {
        grid-column: span 7;
      }
      .u-2 {
        grid-column: span 8;
      }
      .u-2-25 {
        grid-column: span 9;
      }
      .u-6-25 {
        grid-column: span 25;
      }

      /* --- Mouse Styles (Realistic 3D & Fixed Buttons) --- */
      .mouse-area {
        width: 140px;
        height: 220px;
        position: relative;
        perspective: 800px;
        transform-style: preserve-3d;
      }

      .mouse-body {
        width: 100%;
        height: 100%;
        /* Sophisticated Lighting Gradient */
        background: linear-gradient(
          150deg,
          #2a2a2a 0%,
          #151515 40%,
          #050505 100%
        );
        /* Ergonomic contour */
        border-radius: 35% 35% 50% 50% / 20% 20% 50% 50%;
        position: relative;
        transform-style: preserve-3d;
        box-shadow:
          inset 5px 5px 15px rgba(255, 255, 255, 0.05),
          /* Rim Light */ 0 30px 60px rgba(0, 0, 0, 0.8);
      }

      /* Solid Chassis Base */
      .mouse-chassis {
        position: absolute;
        inset: 0;
        background: #080808;
        border-radius: inherit;
        transform: translateZ(-1px);
        /* Thick base extrusion */
        border-bottom: 20px solid #020202;
      }

      /* Palm Logo */
      .mouse-body::before {
        content: "";
        position: absolute;
        top: 70%;
        left: 50%;
        transform: translate(-50%, -50%) translateZ(1px); /* Slight bump */
        width: 30px;
        height: 30px;
        background: conic-gradient(
          from 45deg at 50% 50%,
          transparent 0deg,
          var(--primary) 20deg,
          transparent 40deg,
          transparent 180deg,
          var(--secondary) 200deg,
          transparent 220deg
        );
        filter: drop-shadow(0 0 5px var(--primary)) blur(0.5px);
        opacity: 0.9;
        z-index: 1;
        mix-blend-mode: screen;
        animation: logoPulse 3s infinite alternate;
      }

      @keyframes logoPulse {
        0% {
          opacity: 0.6;
          filter: drop-shadow(0 0 2px var(--primary));
        }
        100% {
          opacity: 1;
          filter: drop-shadow(0 0 8px var(--primary));
        }
      }

      /* RGB Underglow Strip */
      .mouse-body::after {
        content: "";
        position: absolute;
        bottom: 5px;
        left: 15%;
        width: 70%;
        height: 4px;
        background: linear-gradient(
          90deg,
          #ff0000,
          #ffff00,
          #00ff00,
          #00ffff,
          #0000ff,
          #ff00ff,
          #ff0000
        );
        background-size: 200%;
        border-radius: 10px;
        filter: blur(5px);
        opacity: 0.9;
        transform: translateZ(-5px); /* Glows from underneath */
        animation: chromaticFlow 3s linear infinite;
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
      }

      @keyframes chromaticFlow {
        0% {
          background-position: 0% 0%;
        }
        100% {
          background-position: 200% 0%;
        }
      }

      /* --- Floating Split-Trigger Buttons --- */
      .mouse-btn {
        position: absolute;
        top: -5px; /* Overhang front */
        height: 95px;
        width: 44%;
        background: linear-gradient(180deg, #252525 0%, #1a1a1a 100%);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-bottom: 2px solid #000;
        transition: transform 0.05s;
        cursor: pointer;
        transform-style: preserve-3d;
        transform: translateZ(12px); /* High profile buttons */
        box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.1);
      }

      /* Button Thickness (Sidewalls) */
      .mouse-btn::before {
        content: "";
        position: absolute;
        bottom: -6px;
        left: 2px;
        right: 2px;
        height: 6px;
        background: #111;
        transform: translateZ(-6px) translateY(6px);
        filter: brightness(0.6);
      }

      .mouse-left {
        left: 2px;
        border-radius: 10px 4px 4px 20px;
        /* Angled slightly inward */
        transform: translateZ(12px) rotateZ(2deg);
      }

      .mouse-right {
        right: 2px;
        border-radius: 4px 10px 20px 4px;
        /* Angled slightly inward */
        transform: translateZ(12px) rotateZ(-2deg);
      }

      /* --- Integrated Side Buttons --- */
      .mouse-side-group {
        position: absolute;
        top: 110px;
        left: -4px;
        transform-style: preserve-3d;
        /* Rotate to match mouse side curvature */
        transform: rotateY(-20deg) translateZ(5px);
      }

      .mouse-side-btn {
        width: 10px;
        height: 35px;
        background: #333;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 4px 2px 2px 4px;
        margin-bottom: 8px;
        cursor: pointer;
        transition:
          transform 0.1s,
          background 0.1s;
        box-shadow:
          2px 2px 5px rgba(0, 0, 0, 0.5),
          inset 1px 1px 2px rgba(255, 255, 255, 0.1);
        position: relative;
      }

      /* Simulated Groove behind buttons */
      .mouse-side-group::before {
        content: "";
        position: absolute;
        top: -5px;
        bottom: -5px;
        left: -2px;
        right: -2px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 10px;
        transform: translateZ(-2px);
        filter: blur(1px);
      }

      /* --- Scroll Wheel --- */
      .mouse-wheel {
        position: absolute;
        top: 25px;
        left: 50%;
        transform: translateX(-50%) translateZ(10px);
        width: 16px;
        height: 45px;
        background: #111;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.05);
        box-shadow:
          0 0 10px var(--primary),
          inset 0 0 5px var(--primary);
        z-index: 5;
        transition: all 0.1s;
        animation: wheelRGB 6s infinite linear;
      }

      .mouse-wheel::after {
        content: "";
        position: absolute;
        inset: 2px;
        background: repeating-linear-gradient(
          0deg,
          transparent,
          transparent 4px,
          rgba(0, 0, 0, 0.8) 4px,
          rgba(0, 0, 0, 0.8) 6px
        );
      }

      @keyframes wheelRGB {
        0% {
          box-shadow:
            0 0 10px #ff0000,
            inset 0 0 5px #ff0000;
          border-color: #ff0000;
        }
        33% {
          box-shadow:
            0 0 10px #00ff00,
            inset 0 0 5px #00ff00;
          border-color: #00ff00;
        }
        66% {
          box-shadow:
            0 0 10px #0000ff,
            inset 0 0 5px #0000ff;
          border-color: #0000ff;
        }
        100% {
          box-shadow:
            0 0 10px #ff0000,
            inset 0 0 5px #ff0000;
          border-color: #ff0000;
        }
      }

      /* --- Click Interactions --- */
      .mouse-left.active {
        transform: translateZ(12px) rotateZ(2deg) rotateX(-8deg); /* Dip nose */
        background: #1a1a1a;
        border-bottom-color: var(--primary);
        box-shadow: 0 0 15px var(--primary);
      }
      .mouse-right.active {
        transform: translateZ(12px) rotateZ(-2deg) rotateX(-8deg);
        background: #1a1a1a;
        border-bottom-color: var(--secondary);
        box-shadow: 0 0 15px var(--secondary);
      }
      .mouse-wheel.active {
        background: #fff;
        box-shadow: 0 0 30px #fff;
        transform: translateX(-50%) translateZ(8px);
      }
      .mouse-side-btn.active {
        transform: scale(0.9) translateX(2px);
        background: var(--secondary);
        box-shadow: 0 0 10px var(--secondary);
      }

      /* --- HUD / UI --- */
      .hud-overlay {
        position: fixed;
        top: 40px;
        width: 90%;
        display: flex;
        justify-content: space-between;
        pointer-events: none;
        z-index: 20;
        font-family: "Orbitron", sans-serif;
        text-transform: uppercase;
      }

      .hud-panel {
        background: rgba(10, 10, 10, 0.8);
        border: 1px solid rgba(0, 243, 255, 0.3);
        padding: 15px 25px;
        border-radius: 4px;
        backdrop-filter: blur(5px);
        display: flex;
        flex-direction: column;
        gap: 5px;
        box-shadow: 0 0 20px rgba(0, 243, 255, 0.05);
        min-width: 200px;
        pointer-events: auto; /* Allow clicking buttons inside */
      }

      .hud-label {
        font-size: 10px;
        color: #666;
        letter-spacing: 1px;
      }

      .hud-value {
        font-size: 24px;
        color: var(--primary);
        font-weight: 700;
      }

      /* Toggle Switch */
      .rgb-control {
        margin-top: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
      }

      .toggle-switch {
        width: 40px;
        height: 20px;
        background: #333;
        border-radius: 20px;
        position: relative;
        transition: background 0.3s;
      }

      .toggle-switch::after {
        content: "";
        position: absolute;
        top: 2px;
        left: 2px;
        width: 16px;
        height: 16px;
        background: #fff;
        border-radius: 50%;
        transition: transform 0.3s;
      }

      .rgb-control.active .toggle-switch {
        background: var(--primary);
        box-shadow: 0 0 10px var(--primary);
      }

      .rgb-control.active .toggle-switch::after {
        transform: translateX(20px);
      }

      .mic-control.active .toggle-switch {
        background: var(--accent);
        box-shadow: 0 0 10px var(--accent);
      }

      .mic-control.active .toggle-switch::after {
        transform: translateX(20px);
      }

      .control-label {
        font-size: 12px;
        color: #fff;
      }

      /* History Tape - Aligned Right, Content Flow Left-to-Right */
      .history-tape {
        position: fixed;
        bottom: 80px; /* previously 40px */
        left: 50%;
        transform: translateX(-50%);
        width: 60%;
        height: 50px;
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: flex-end; /* Aligns content to the right end */
        overflow: hidden;
        padding: 0 20px;
        font-family: "JetBrains Mono", monospace;
        color: var(--accent);
        font-size: 18px;
        z-index: 20;
      }

      .history-char {
        margin-left: 5px;
        white-space: nowrap;
        /* Fade Out and Slide Logic */
        animation: typeFade 2.5s forwards ease-out;
        opacity: 1;
      }

      @keyframes typeFade {
        0% {
          opacity: 0;
          transform: translateX(10px);
          color: #fff;
          text-shadow: 0 0 15px #fff; /* White glow initially */
        }
        10% {
          opacity: 1;
          transform: translateX(0);
          color: #fff;
        }
        60% {
          opacity: 1;
          color: #fff; /* CHANGED from var(--accent) to keep it white */
          text-shadow: none;
        }
        100% {
          opacity: 0;
          color: #fff;
          transform: translateX(0);
        }
      }

      /* Mobile Overlay - Only show on very small screens (< 600px) */
      .mobile-warning {
        display: none;
        position: fixed;
        inset: 0;
        background: black;
        z-index: 999;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 20px;
      }

      @media (max-width: 600px) {
        .mobile-warning {
          display: flex;
        }
      }

      .logo {
        position: fixed;
        bottom: 60px; /* previously 20px */
        right: 20px;
        font-family: "Orbitron", sans-serif;
        font-size: 12px;
        color: rgba(255, 255, 255, 0.2);
      }
    </style>
  </head>
  <body>
    <div class="mobile-warning">
      <h2 style="color: var(--primary)">DESKTOP REQUIRED</h2>
      <p>This immersive experience requires a physical keyboard and mouse.</p>
    </div>

    <div class="ambient-glow"></div>
    <canvas id="particles"></canvas>

    <div class="hud-overlay">
      <div class="hud-panel">
        <span class="hud-label">Inputs / Sec</span>
        <span class="hud-value" id="kps-display">0</span>

        <div class="rgb-control" id="rgb-toggle">
          <div class="toggle-switch"></div>
          <span class="control-label">RGB MODE</span>
        </div>

        <!-- New Mic Input Toggle -->
        <div class="rgb-control mic-control" id="mic-toggle">
          <div class="toggle-switch"></div>
          <span class="control-label">MIC INPUT</span>
        </div>
      </div>
      <div class="hud-panel" style="align-items: flex-end">
        <span class="hud-label">Last Input</span>
        <span class="hud-value" id="last-key" style="color: var(--secondary)"
          >WAITING</span
        >
      </div>
    </div>

    <!-- Music Visualizer Added Here -->
    <canvas id="audio-visualizer"></canvas>

    <div class="desk-setup" id="desk">
      <!-- Generated via JS -->
      <div class="keyboard-frame" id="kb-frame">
        <div class="keyboard-layout" id="keyboard"></div>
      </div>

      <div class="mouse-area">
        <div class="mouse-body">
          <div class="mouse-chassis"></div>

          <div class="mouse-btn mouse-left" id="mouse-0"></div>
          <div class="mouse-btn mouse-right" id="mouse-2"></div>
          <div class="mouse-wheel" id="mouse-1"></div>

          <!-- Side Buttons Grouped for better rotation -->
          <div class="mouse-side-group">
            <div class="mouse-side-btn side-fwd" id="mouse-4"></div>
            <div class="mouse-side-btn side-back" id="mouse-3"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="history-tape" id="history"></div>
    <div class="logo">FOREVERABHI</div>

    <script>
      /**
       * CONFIG & STATE
       */
      const state = {
        kps: 0,
        keyStrokes: [],
        lastTime: Date.now(),
        rgbMode: false,
        micMode: false,
      };

      // Keymap: 75% Compact Layout (84 Keys)
      const keyMap = [
        // Row 0 (F-Row)
        { code: "Escape", label: "ESC", width: "u-1", row: 0 },
        { code: "F1", label: "F1", width: "u-1", row: 0 },
        { code: "F2", label: "F2", width: "u-1", row: 0 },
        { code: "F3", label: "F3", width: "u-1", row: 0 },
        { code: "F4", label: "F4", width: "u-1", row: 0 },
        { code: "F5", label: "F5", width: "u-1", row: 0 },
        { code: "F6", label: "F6", width: "u-1", row: 0 },
        { code: "F7", label: "F7", width: "u-1", row: 0 },
        { code: "F8", label: "F8", width: "u-1", row: 0 },
        { code: "F9", label: "F9", width: "u-1", row: 0 },
        { code: "F10", label: "F10", width: "u-1", row: 0 },
        { code: "F11", label: "F11", width: "u-1", row: 0 },
        { code: "F12", label: "F12", width: "u-1", row: 0 },
        { code: "PrintScreen", label: "PRT", width: "u-1", row: 0 },
        { code: "Pause", label: "PAU", width: "u-1", row: 0 },
        { code: "Delete", label: "DEL", width: "u-1", row: 0 },

        // Row 1 (Index 0-13)
        { code: "Backquote", label: "`", width: "u-1", row: 1 },
        { code: "Digit1", label: "1", width: "u-1", row: 1 },
        { code: "Digit2", label: "2", width: "u-1", row: 1 },
        { code: "Digit3", label: "3", width: "u-1", row: 1 },
        { code: "Digit4", label: "4", width: "u-1", row: 1 },
        { code: "Digit5", label: "5", width: "u-1", row: 1 },
        { code: "Digit6", label: "6", width: "u-1", row: 1 },
        { code: "Digit7", label: "7", width: "u-1", row: 1 },
        { code: "Digit8", label: "8", width: "u-1", row: 1 },
        { code: "Digit9", label: "9", width: "u-1", row: 1 },
        { code: "Digit0", label: "0", width: "u-1", row: 1 },
        { code: "Minus", label: "-", width: "u-1", row: 1 },
        { code: "Equal", label: "=", width: "u-1", row: 1 },
        { code: "Backspace", label: "←", width: "u-2", row: 1 },
        { code: "Home", label: "HM", width: "u-1", row: 1 },

        // Row 2 (Index 14-27)
        { code: "Tab", label: "TAB", width: "u-1-5", row: 2 },
        { code: "KeyQ", label: "Q", width: "u-1", row: 2 },
        { code: "KeyW", label: "W", width: "u-1", row: 2 },
        { code: "KeyE", label: "E", width: "u-1", row: 2 },
        { code: "KeyR", label: "R", width: "u-1", row: 2 },
        { code: "KeyT", label: "T", width: "u-1", row: 2 },
        { code: "KeyY", label: "Y", width: "u-1", row: 2 },
        { code: "KeyU", label: "U", width: "u-1", row: 2 },
        { code: "KeyI", label: "I", width: "u-1", row: 2 },
        { code: "KeyO", label: "O", width: "u-1", row: 2 },
        { code: "KeyP", label: "P", width: "u-1", row: 2 },
        { code: "BracketLeft", label: "[", width: "u-1", row: 2 },
        { code: "BracketRight", label: "]", width: "u-1", row: 2 },
        { code: "Backslash", label: "\\", width: "u-1-5", row: 2 },
        { code: "PageUp", label: "PU", width: "u-1", row: 2 },

        // Row 3 (Index 28-40)
        { code: "CapsLock", label: "CAPS", width: "u-1-75", row: 3 },
        { code: "KeyA", label: "A", width: "u-1", row: 3 },
        { code: "KeyS", label: "S", width: "u-1", row: 3 },
        { code: "KeyD", label: "D", width: "u-1", row: 3 },
        { code: "KeyF", label: "F", width: "u-1", row: 3 },
        { code: "KeyG", label: "G", width: "u-1", row: 3 },
        { code: "KeyH", label: "H", width: "u-1", row: 3 },
        { code: "KeyJ", label: "J", width: "u-1", row: 3 },
        { code: "KeyK", label: "K", width: "u-1", row: 3 },
        { code: "KeyL", label: "L", width: "u-1", row: 3 },
        { code: "Semicolon", label: ";", width: "u-1", row: 3 },
        { code: "Quote", label: "'", width: "u-1", row: 3 },
        { code: "Enter", label: "ENTER", width: "u-2-25", row: 3 },
        { code: "PageDown", label: "PD", width: "u-1", row: 3 },

        // Row 4 (Index 41-52)
        { code: "ShiftLeft", label: "SHIFT", width: "u-2-25", row: 4 },
        { code: "KeyZ", label: "Z", width: "u-1", row: 4 },
        { code: "KeyX", label: "X", width: "u-1", row: 4 },
        { code: "KeyC", label: "C", width: "u-1", row: 4 },
        { code: "KeyV", label: "V", width: "u-1", row: 4 },
        { code: "KeyB", label: "B", width: "u-1", row: 4 },
        { code: "KeyN", label: "N", width: "u-1", row: 4 },
        { code: "KeyM", label: "M", width: "u-1", row: 4 },
        { code: "Comma", label: ",", width: "u-1", row: 4 },
        { code: "Period", label: ".", width: "u-1", row: 4 },
        { code: "Slash", label: "/", width: "u-1", row: 4 },
        { code: "ShiftRight", label: "SFT", width: "u-1-75", row: 4 },
        { code: "ArrowUp", label: "↑", width: "u-1", row: 4 },
        { code: "End", label: "END", width: "u-1", row: 4 },

        // Row 5 (Index 53-60)
        { code: "ControlLeft", label: "CTRL", width: "u-1-25", row: 5 },
        { code: "MetaLeft", label: "WIN", width: "u-1-25", row: 5 },
        { code: "AltLeft", label: "ALT", width: "u-1-25", row: 5 },
        { code: "Space", label: "", width: "u-6-25", row: 5 },
        { code: "AltRight", label: "ALT", width: "u-1", row: 5 },
        { code: "MetaRight", label: "FN", width: "u-1", row: 5 },
        { code: "ControlRight", label: "CTRL", width: "u-1", row: 5 },
        { code: "ArrowLeft", label: "←", width: "u-1", row: 5 },
        { code: "ArrowDown", label: "↓", width: "u-1", row: 5 },
        { code: "ArrowRight", label: "→", width: "u-1", row: 5 },
      ];

      /**
       * AUDIO ENGINE (Procedural Mechanical Sounds & Visualizer)
       */
      class AudioSynth {
        constructor() {
          this.ctx = new (window.AudioContext || window.webkitAudioContext)();
          this.analyser = this.ctx.createAnalyser();
          this.analyser.fftSize = 256;
          this.bufferLength = this.analyser.frequencyBinCount;
          this.dataArray = new Uint8Array(this.bufferLength);

          this.masterGain = this.ctx.createGain();
          this.masterGain.gain.value = 0.3; // Volume control

          // Route: Click/Thock -> MasterGain -> Analyser -> Destination
          this.masterGain.connect(this.analyser);
          this.analyser.connect(this.ctx.destination);

          this.micStream = null;
          this.micSource = null;

          this.initVisualizer();
        }

        // Request Mic Access
        async enableMic() {
          try {
            this.micStream = await navigator.mediaDevices.getUserMedia({
              audio: true,
            });
            this.micSource = this.ctx.createMediaStreamSource(this.micStream);
            // Disconnect master gain from analyser to avoid mixing if desired,
            // or keep both. Here we disconnect internal synth visual to show mic only.
            this.masterGain.disconnect(this.analyser);
            this.masterGain.connect(this.ctx.destination); // Keep synth audible

            this.micSource.connect(this.analyser);
            return true;
          } catch (err) {
            console.error("Mic Error:", err);
            return false;
          }
        }

        disableMic() {
          if (this.micStream) {
            this.micStream.getTracks().forEach((track) => track.stop());
            if (this.micSource) this.micSource.disconnect();

            // Reconnect internal synth to visualizer
            this.masterGain.disconnect(this.ctx.destination);
            this.masterGain.connect(this.analyser);
            this.analyser.connect(this.ctx.destination);
          }
        }

        initVisualizer() {
          const canvas = document.getElementById("audio-visualizer");
          const ctx = canvas.getContext("2d");
          canvas.width = canvas.offsetWidth;
          canvas.height = canvas.offsetHeight;

          const draw = () => {
            requestAnimationFrame(draw);

            this.analyser.getByteFrequencyData(this.dataArray);

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const barWidth = (canvas.width / this.bufferLength) * 2.5;
            let barHeight;
            let x = 0;

            for (let i = 0; i < this.bufferLength; i++) {
              barHeight = this.dataArray[i] / 2;

              // Neon Gradient
              const gradient = ctx.createLinearGradient(0, canvas.height, 0, 0);
              gradient.addColorStop(0, "#00f3ff");
              gradient.addColorStop(1, "#bd00ff");

              ctx.fillStyle = gradient;
              // Draw rounded bars
              ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);

              x += barWidth + 2;
            }
          };
          draw();
        }

        playClick(type = "standard") {
          if (this.ctx.state === "suspended") this.ctx.resume();

          const t = this.ctx.currentTime;

          // 1. The "Click" (High frequency transient)
          const clickOsc = this.ctx.createOscillator();
          const clickGain = this.ctx.createGain();

          clickOsc.type = "square";
          // Variation based on key type
          clickOsc.frequency.setValueAtTime(
            type === "space" ? 800 : type === "enter" ? 1000 : 1200,
            t,
          );
          clickOsc.frequency.exponentialRampToValueAtTime(100, t + 0.05);

          clickGain.gain.setValueAtTime(1, t);
          clickGain.gain.exponentialRampToValueAtTime(0.01, t + 0.05);

          clickOsc.connect(clickGain);
          clickGain.connect(this.masterGain);
          clickOsc.start(t);
          clickOsc.stop(t + 0.05);

          // 2. The "Thock" (Body resonance)
          const bodyOsc = this.ctx.createOscillator();
          const bodyGain = this.ctx.createGain();

          bodyOsc.type = "triangle";
          bodyOsc.frequency.setValueAtTime(type === "space" ? 150 : 200, t);

          bodyGain.gain.setValueAtTime(0.5, t);
          bodyGain.gain.exponentialRampToValueAtTime(0.01, t + 0.15);

          // Lowpass filter for plastic sound
          const filter = this.ctx.createBiquadFilter();
          filter.type = "lowpass";
          filter.frequency.value = 800;

          bodyOsc.connect(filter);
          filter.connect(bodyGain);
          bodyGain.connect(this.masterGain);

          bodyOsc.start(t);
          bodyOsc.stop(t + 0.15);
        }
      }

      const audio = new AudioSynth();

      /**
       * PARTICLE SYSTEM
       */
      const canvas = document.getElementById("particles");
      const ctx = canvas.getContext("2d");
      let particles = [];

      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        // Also resize audio visualizer if needed
        const vCanvas = document.getElementById("audio-visualizer");
        if (vCanvas) {
          vCanvas.width = vCanvas.offsetWidth;
          vCanvas.height = vCanvas.offsetHeight;
        }
      }
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      class Particle {
        constructor(x, y, color) {
          this.x = x;
          this.y = y;
          this.color = color;
          const angle = Math.random() * Math.PI * 2;
          const speed = Math.random() * 3 + 2;
          this.vx = Math.cos(angle) * speed;
          this.vy = Math.sin(angle) * speed;
          this.life = 1;
          this.decay = Math.random() * 0.03 + 0.02;
          this.size = Math.random() * 3 + 1;
        }

        update() {
          this.x += this.vx;
          this.y += this.vy;
          this.life -= this.decay;
          this.size *= 0.95;
        }

        draw(ctx) {
          ctx.globalAlpha = this.life;
          ctx.fillStyle = this.color;
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fill();
          ctx.globalAlpha = 1;
        }
      }

      function spawnParticles(x, y, type) {
        let color = "#00f3ff"; // Default Cyan
        if (type === "mouse") color = "#bd00ff"; // Purple mouse
        if (type === "space") color = "#00ff9d"; // Green Space
        if (state.rgbMode) {
          // If RGB mode is on, randomize particle color or use current time color
          const time = Date.now() / 10;
          color = `hsl(${time % 360}, 100%, 50%)`;
        }

        for (let i = 0; i < 8; i++) {
          particles.push(new Particle(x, y, color));
        }
      }

      function animateParticles() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = particles.length - 1; i >= 0; i--) {
          const p = particles[i];
          p.update();
          p.draw(ctx);
          if (p.life <= 0) particles.splice(i, 1);
        }
        requestAnimationFrame(animateParticles);
      }
      animateParticles();

      /**
       * INITIALIZATION
       */
      const kbContainer = document.getElementById("keyboard");
      const keyElements = {}; // Map code -> element

      // Render Keyboard
      keyMap.forEach((k) => {
        const el = document.createElement("div");
        el.className = `key ${k.width}`;
        // Set Row CSS Variable for RGB wave delay
        el.style.setProperty("--row", k.row);

        if (
          ["ControlLeft", "AltLeft", "ShiftLeft", "MetaLeft"].includes(k.code)
        )
          el.classList.add("modifier");

        el.innerHTML = `<div class="key-cap">${k.label}</div>`;
        el.dataset.code = k.code;

        kbContainer.appendChild(el);
        keyElements[k.code] = el;
      });

      // UI Refs
      const lastKeyDisplay = document.getElementById("last-key");
      const kpsDisplay = document.getElementById("kps-display");
      const historyTape = document.getElementById("history");
      const rgbToggle = document.getElementById("rgb-toggle");
      const micToggle = document.getElementById("mic-toggle");
      const kbFrame = document.getElementById("kb-frame");

      // RGB Toggle Logic
      rgbToggle.addEventListener("click", () => {
        state.rgbMode = !state.rgbMode;
        rgbToggle.classList.toggle("active");
        kbFrame.classList.toggle("rgb-active");
        if (state.rgbMode) {
          document.body.classList.add("rgb-mode");
        } else {
          document.body.classList.remove("rgb-mode");
        }
      });

      // Mic Toggle Logic
      micToggle.addEventListener("click", async () => {
        if (!state.micMode) {
          const success = await audio.enableMic();
          if (success) {
            state.micMode = true;
            micToggle.classList.add("active");
          }
        } else {
          audio.disableMic();
          state.micMode = false;
          micToggle.classList.remove("active");
        }
      });

      // Mouse Elements
      const mouseEls = {
        0: document.getElementById("mouse-0"), // Left
        1: document.getElementById("mouse-1"), // Middle
        2: document.getElementById("mouse-2"), // Right
        3: document.getElementById("mouse-3"), // Back
        4: document.getElementById("mouse-4"), // Forward
      };

      /**
       * INTERACTION HANDLERS
       */
      function handleInput(code, type, x, y) {
        // Update HUD
        lastKeyDisplay.innerText = code
          .replace("Key", "")
          .replace("Digit", "")
          .toUpperCase();

        // Stats
        const now = Date.now();
        state.keyStrokes = state.keyStrokes.filter((t) => now - t < 1000); // Keep last 1s
        state.keyStrokes.push(now);
        kpsDisplay.innerText = state.keyStrokes.length;

        // Audio
        let soundType = "standard";
        if (code === "Space") soundType = "space";
        if (code === "Enter") soundType = "enter";
        audio.playClick(soundType);

        // Particles
        if (x && y) spawnParticles(x, y, type);

        // History (Left to Right, Aligned Right)
        if (type === "key" && code.length === 4 && code.startsWith("Key")) {
          const span = document.createElement("span");
          span.className = "history-char";
          span.innerText = code.slice(3);

          // Add listener to remove element when fade animation ends
          span.addEventListener("animationend", () => {
            span.remove();
          });

          // Append to end (Left-to-Right reading order)
          historyTape.appendChild(span);

          // Limit total items strictly just in case
          if (historyTape.children.length > 30) {
            historyTape.removeChild(historyTape.firstChild);
          }
        }
      }

      // Keyboard Event Listeners
      window.addEventListener("keydown", (e) => {
        if (e.repeat) return;

        // Fix for Windows AltGr (Right Alt) triggering Left Control
        if (e.code === "AltRight") {
          const ctrlLeft = keyElements["ControlLeft"];
          if (ctrlLeft) {
            // Forcefully remove active state
            ctrlLeft.classList.remove("active");

            // Canvas Cleanup: Remove "burst" particles from the fake Ctrl press
            // This scrubs the visual artifact that appeared milliseconds ago
            const rect = ctrlLeft.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;

            // Filter out particles that were spawned near Left Control (radius 100px)
            particles = particles.filter((p) => {
              const dist = Math.hypot(p.x - cx, p.y - cy);
              return dist > 100;
            });
          }
        }

        const keyEl = keyElements[e.code];
        if (keyEl) {
          keyEl.classList.add("active");

          // Get coordinates for particles
          const rect = keyEl.getBoundingClientRect();
          const centerX = rect.left + rect.width / 2;
          const centerY = rect.top + rect.height / 2;

          handleInput(e.code, "key", centerX, centerY);
        }

        // Prevent default browser actions for some keys to keep focus
        if (e.code === "Tab" || e.code === "AltLeft" || e.code === "AltRight")
          e.preventDefault();
      });

      window.addEventListener("keyup", (e) => {
        const keyEl = keyElements[e.code];
        if (keyEl) {
          keyEl.classList.remove("active");
        }
      });

      // Mouse Event Listeners
      window.addEventListener("mousedown", (e) => {
        const btn = mouseEls[e.button];
        if (btn) {
          btn.classList.add("active");
          handleInput(`MOUSE ${e.button}`, "mouse", e.clientX, e.clientY);
        }
      });

      window.addEventListener("mouseup", (e) => {
        const btn = mouseEls[e.button];
        if (btn) btn.classList.remove("active");
      });

      // Mouse Parallax Effect
      document.addEventListener("mousemove", (e) => {
        const desk = document.getElementById("desk");
        const x = (window.innerWidth / 2 - e.clientX) / 50;
        const y = (window.innerHeight / 2 - e.clientY) / 50;

        desk.style.transform = `rotateX(${30 + y}deg) rotateY(${-x}deg) scale(0.9)`;
      });

      // Prevent Context Menu
      window.addEventListener("contextmenu", (e) => e.preventDefault());
    </script>
  </body>
</html>
